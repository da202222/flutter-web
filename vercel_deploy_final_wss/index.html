<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" and is used
    only for generating correct absolute URLs during Flutter initialization,
    when the application is loaded via a web server.

    Placing a leading or trailing slash in the href is not recommended.
    Modify the href attribute when deploying to avoid conflicts with
    web server routing, potentially breaking web app embedding.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="çš®å¸¦ç§¤æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ">
  <meta name="flutter-service-worker-version" content=""2252706144"">

  <!-- Mobile web app meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ</title>
  <link rel="manifest" href="manifest.json">


  <!-- MQTT.js åŠ è½½ï¼ˆCDN + æœ¬åœ°fallbackï¼‰ -->
  <script>
    function loadMqtt() {
      const cdnUrl = 'https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
      const localUrl = 'mqtt.js'; // å®é™…æ–‡ä»¶ä½äºweb/mqtt.js
      
      // åˆ›å»ºè„šæœ¬åŠ è½½å‡½æ•°
      const loadScript = (url, isFallback = false) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.onload = () => {
            console.log(`MQTT.js ${isFallback ? 'æœ¬åœ°' : 'CDN'}åŠ è½½æˆåŠŸ`);
            window.mqtt = mqtt; // è®¾ç½®Dartä»£ç éœ€è¦çš„å…¨å±€å˜é‡
            resolve();
          };
          script.onerror = () => {
            console.warn(`åŠ è½½å¤±è´¥: ${url}`);
            reject();
          };
          document.head.appendChild(script);
        });
      };

      // å…ˆå°è¯•CDNï¼Œå¤±è´¥åå°è¯•æœ¬åœ°
      loadScript(cdnUrl)
        .catch(() => loadScript(localUrl, true))
        .catch(() => console.error('MQTT.jsåŠ è½½å®Œå…¨å¤±è´¥'));
    }
    
    window.addEventListener('DOMContentLoaded', loadMqtt);
  </script>

    <style>
      /* ç»Ÿä¸€å­—ä½“è®¾ç½® */
      html, body, flt-semantics, flt-glass-pane, flt-scene-host {
        font-family: -apple-system, BlinkMacSystemFont, 
                     "Segoe UI", "Microsoft YaHei", "å¾®è½¯é›…é»‘", 
                     sans-serif;
        margin: 0;
        padding: 0;
        /* ç¡®ä¿ä¸­æ–‡å­—ä½“ä¼˜å…ˆ */
        font-display: swap;
      }
      
      /* æ˜¾å¼å£°æ˜ä¸­æ–‡å­—ä½“ */
      @font-face {
        font-family: "Microsoft YaHei";
        font-style: normal;
        font-weight: 400;
        src: local("Microsoft YaHei"), local("å¾®è½¯é›…é»‘");
      }
    
    /* åŠ è½½ç”»é¢ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
    }
    
    .loading h1 {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 300;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <h1>çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ</h1>
    <div class="spinner"></div>
    <p style="margin-top: 20px;">æ­£åœ¨åŠ è½½åº”ç”¨...</p>
  </div>

  <script>
    // éšè—åŠ è½½ç”»é¢ï¼ˆæ”¯æŒPWAæ¨¡å¼ï¼‰
    function hideLoading() {
      const loadingEl = document.getElementById('loading');
      if (loadingEl) loadingEl.style.display = 'none';
    }
    
    // ä»…ä½¿ç”¨flutter-first-frameäº‹ä»¶éšè—åŠ è½½ç”»é¢
    window.addEventListener('flutter-first-frame', hideLoading);
  </script>

  <script src="flutter.js" defer></script>
  <script>
    window.addEventListener('load', function(ev) {
      // æ£€æŸ¥FlutteråŠ è½½å™¨æ˜¯å¦å¯ç”¨
      if (typeof _flutter === 'undefined') {
        console.error('âŒ FlutteråŠ è½½å™¨æœªå®šä¹‰ï¼Œå°è¯•å¤‡ç”¨åŠ è½½æ–¹æ³•');

        // å¤‡ç”¨åŠ è½½æ–¹æ³•
        if (typeof flutter_bootstrap !== 'undefined') {
          console.log('ğŸ”„ ä½¿ç”¨flutter_bootstrapåŠ è½½');
          flutter_bootstrap.loadEntrypoint({
            onEntrypointLoaded: function(engineInitializer) {
              engineInitializer.initializeEngine().then(function(appRunner) {
                appRunner.runApp();
              });
            }
          });
        } else {
          console.error('âŒ æ‰€æœ‰FlutteråŠ è½½æ–¹æ³•éƒ½å¤±è´¥');
          // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
          document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-family: Arial, sans-serif; text-align: center;">
              <div>
                <h1>ğŸš« åº”ç”¨åŠ è½½å¤±è´¥</h1>
                <p>Flutter Webåº”ç”¨æ— æ³•æ­£å¸¸åŠ è½½</p>
                <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•</p>
                <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; background: white; color: #333; border: none; border-radius: 5px; cursor: pointer;">åˆ·æ–°é¡µé¢</button>
              </div>
            </div>
          `;
        }
        return;
      }

      // ä¿®å¤serviceWorkerVersionæœªå®šä¹‰é—®é¢˜
      const serviceWorkerVersionMeta = document.querySelector('meta[name="flutter-service-worker-version"]');
      const serviceWorkerVersion = serviceWorkerVersionMeta ? serviceWorkerVersionMeta.content : '';

      // ä½¿ç”¨æ ‡å‡†FlutteråŠ è½½æ–¹æ³•
      _flutter.loader.loadEntrypoint({
        serviceWorker: {
          serviceWorkerVersion: serviceWorkerVersion,
        },
        onEntrypointLoaded: function(engineInitializer) {
          engineInitializer.initializeEngine().then(function(appRunner) {
            appRunner.runApp();
            console.log('âœ… Flutteråº”ç”¨å¯åŠ¨æˆåŠŸ');
          }).catch(function(error) {
            console.error('âŒ Flutterå¼•æ“åˆå§‹åŒ–å¤±è´¥:', error);
          });
        }
      }).catch(function(error) {
        console.error('âŒ Flutterå…¥å£ç‚¹åŠ è½½å¤±è´¥:', error);
      });
    });
  </script>

  <script>
    // Stagewise Toolbar Initialization
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      (function() {
        const script = document.createElement('script');
        script.src = 'https://cdn.stagewise.dev/toolbar.js';
        script.async = true;
        script.onload = function() {
          window.Stagewise.init({
            plugins: [],
            environment: 'development'
          });
        };
        document.head.appendChild(script);
      })();
    }
  </script>
</body>
</html>
