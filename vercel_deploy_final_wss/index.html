<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" and is used
    only for generating correct absolute URLs during Flutter initialization,
    when the application is loaded via a web server.

    Placing a leading or trailing slash in the href is not recommended.
    Modify the href attribute when deploying to avoid conflicts with
    web server routing, potentially breaking web app embedding.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="çš®å¸¦ç§¤æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ">
  <meta name="flutter-service-worker-version" content="{{flutter_service_worker_version}}">

  <!-- Mobile web app meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ</title>
  <link rel="manifest" href="manifest.json">


  <!-- MQTT.js åŠ è½½ï¼ˆCDN + æœ¬åœ°fallbackï¼‰ -->
  <script>
    function loadMqtt() {
      const cdnUrl = 'https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
      const localUrl = 'mqtt.js'; // å®é™…æ–‡ä»¶ä½äºweb/mqtt.js

      // åˆ›å»ºè„šæœ¬åŠ è½½å‡½æ•°
      const loadScript = (url, isFallback = false) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.onload = () => {
            console.log(`MQTT.js ${isFallback ? 'æœ¬åœ°' : 'CDN'}åŠ è½½æˆåŠŸ`);
            window.mqtt = mqtt; // è®¾ç½®Dartä»£ç éœ€è¦çš„å…¨å±€å˜é‡
            resolve();
          };
          script.onerror = () => {
            console.warn(`åŠ è½½å¤±è´¥: ${url}`);
            reject();
          };
          document.head.appendChild(script);
        });
      };

      // å…ˆå°è¯•CDNï¼Œå¤±è´¥åå°è¯•æœ¬åœ°
      loadScript(cdnUrl)
        .catch(() => loadScript(localUrl, true))
        .catch(() => console.error('MQTT.jsåŠ è½½å®Œå…¨å¤±è´¥'));
    }

    window.addEventListener('DOMContentLoaded', loadMqtt);
  </script>

  <!-- WSSè¿æ¥é…ç½®å’Œç¯å¢ƒæ£€æµ‹ -->
  <script>
    // WSSè¿æ¥ä¼˜åŒ–å’Œç¯å¢ƒæ£€æµ‹
    (function() {
      const isHttps = window.location.protocol === 'https:';
      const hostname = window.location.hostname;
      const isVercel = hostname.includes('vercel.app') || hostname.includes('2222503.xyz');
      const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

      // æ™ºèƒ½åè®®é€‰æ‹© - ä¼˜å…ˆä½¿ç”¨WSS
      const mqttConfig = {
        protocol: isHttps ? 'wss' : 'ws',
        host: '117.72.196.137',
        port: isHttps ? 8084 : 8083,
        path: '/mqtt'
      };

      const mqttUrl = `${mqttConfig.protocol}://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;

      console.log('ğŸŒ WSSç¯å¢ƒä¿¡æ¯:', {
        protocol: window.location.protocol,
        hostname: hostname,
        isVercel: isVercel,
        isHttps: isHttps,
        isLocalhost: isLocalhost,
        mqttUrl: mqttUrl,
        selectedProtocol: mqttConfig.protocol.toUpperCase()
      });

      // ä¸ºFlutteråº”ç”¨æä¾›å…¨å±€WSSé…ç½®
      window.getOptimalMqttConfig = function() {
        return {
          url: mqttUrl,
          config: mqttConfig,
          environment: {
            isHttps: isHttps,
            isVercel: isVercel,
            isLocalhost: isLocalhost,
            hostname: hostname
          },
          wssEnabled: mqttConfig.protocol === 'wss'
        };
      };

      // WSSé¢„è¿æ¥æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
      window.testMqttConnection = function() {
        return new Promise((resolve, reject) => {
          try {
            const client = mqtt.connect(mqttUrl, {
              clientId: 'vercel_wss_test_' + Math.random().toString(16).substr(2, 8),
              clean: true,
              connectTimeout: 10000,
              reconnectPeriod: 0,
              keepalive: 60
            });

            const timeout = setTimeout(() => {
              client.end();
              reject(new Error('è¿æ¥è¶…æ—¶'));
            }, 10000);

            client.on('connect', () => {
              clearTimeout(timeout);
              console.log('âœ… WSSé¢„è¿æ¥æµ‹è¯•æˆåŠŸ');
              client.end();
              resolve(true);
            });

            client.on('error', (error) => {
              clearTimeout(timeout);
              console.error('âŒ WSSé¢„è¿æ¥æµ‹è¯•å¤±è´¥:', error);
              reject(error);
            });

          } catch (error) {
            console.error('âŒ WSSé…ç½®é”™è¯¯:', error);
            reject(error);
          }
        });
      };

      // è°ƒè¯•ä¿¡æ¯
      window.debugMqttInfo = function() {
        console.log('ğŸ” MQTTè°ƒè¯•ä¿¡æ¯:', window.getOptimalMqttConfig());
      };

    })();
  </script>

    <style>
      /* ç»Ÿä¸€å­—ä½“è®¾ç½® */
      html, body, flt-semantics, flt-glass-pane, flt-scene-host {
        font-family: -apple-system, BlinkMacSystemFont, 
                     "Segoe UI", "Microsoft YaHei", "å¾®è½¯é›…é»‘", 
                     sans-serif;
        margin: 0;
        padding: 0;
        /* ç¡®ä¿ä¸­æ–‡å­—ä½“ä¼˜å…ˆ */
        font-display: swap;
      }
      
      /* æ˜¾å¼å£°æ˜ä¸­æ–‡å­—ä½“ */
      @font-face {
        font-family: "Microsoft YaHei";
        font-style: normal;
        font-weight: 400;
        src: local("Microsoft YaHei"), local("å¾®è½¯é›…é»‘");
      }
    
    /* åŠ è½½ç”»é¢ - WSSä¼˜åŒ–ç‰ˆæœ¬ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-sizing: border-box;
    }

    .loading h1 {
      margin-bottom: 10px;
      font-size: 28px;
      font-weight: 600;
      text-align: center;
    }

    .loading .subtitle {
      margin-bottom: 30px;
      font-size: 16px;
      font-weight: 300;
      opacity: 0.9;
      text-align: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .mqtt-status {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
      min-width: 300px;
      max-width: 400px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      font-size: 14px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .status-connecting { background-color: #ffc107; }
    .status-connected { background-color: #28a745; animation: none; }
    .status-error { background-color: #dc3545; animation: none; }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <h1>ğŸ¦Ÿ çš®å¸¦ç§¤ç›‘æ§ç³»ç»Ÿ</h1>
    <div class="subtitle">WSSå®‰å…¨è¿æ¥ Â· Verceléƒ¨ç½²ä¼˜åŒ–</div>
    <div class="spinner"></div>
    <p style="margin-top: 10px;">æ­£åœ¨åˆå§‹åŒ–WSSè¿æ¥...</p>

    <div class="mqtt-status">
      <div class="status-item">
        <span>ğŸŒ éƒ¨ç½²ç¯å¢ƒ</span>
        <span id="env-status">æ£€æµ‹ä¸­...</span>
      </div>
      <div class="status-item">
        <span>ğŸ”’ è¿æ¥åè®®</span>
        <span id="protocol-status">è‡ªåŠ¨é€‰æ‹©ä¸­...</span>
      </div>
      <div class="status-item">
        <span>ğŸ“¡ MQTTæœåŠ¡å™¨</span>
        <span id="server-info">117.72.196.137</span>
      </div>
      <div class="status-item">
        <span>ğŸ”— è¿æ¥çŠ¶æ€</span>
        <span id="mqtt-connection-status">
          <span class="status-indicator status-connecting"></span>
          å‡†å¤‡è¿æ¥
        </span>
      </div>
    </div>
  </div>

  <script>
    // WSSçŠ¶æ€æ›´æ–°å’ŒåŠ è½½ç”»é¢ç®¡ç†
    (function() {
      // æ›´æ–°ç¯å¢ƒçŠ¶æ€æ˜¾ç¤º
      function updateEnvironmentStatus() {
        const isHttps = window.location.protocol === 'https:';
        const hostname = window.location.hostname;
        const isVercel = hostname.includes('vercel.app') || hostname.includes('2222503.xyz');
        const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

        let envText = '';
        if (isVercel) {
          envText = 'Vercel (ç”Ÿäº§)';
        } else if (isLocalhost) {
          envText = 'æœ¬åœ°å¼€å‘';
        } else {
          envText = isHttps ? 'HTTPS' : 'HTTP';
        }

        const protocolText = isHttps ? 'WSS (å®‰å…¨)' : 'WS (æ ‡å‡†)';
        const serverText = `117.72.196.137:${isHttps ? '8084' : '8083'} (${isHttps ? 'WSS' : 'WS'})`;

        // æ›´æ–°æ˜¾ç¤º
        const envEl = document.getElementById('env-status');
        const protocolEl = document.getElementById('protocol-status');
        const serverEl = document.getElementById('server-info');

        if (envEl) envEl.textContent = envText;
        if (protocolEl) protocolEl.textContent = protocolText;
        if (serverEl) serverEl.textContent = serverText;

        console.log('ğŸŒ ç¯å¢ƒçŠ¶æ€æ›´æ–°:', {
          environment: envText,
          protocol: protocolText,
          server: serverText,
          isHttps: isHttps,
          isVercel: isVercel
        });
      }

      // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°çŠ¶æ€
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateEnvironmentStatus);
      } else {
        updateEnvironmentStatus();
      }

      // éšè—åŠ è½½ç”»é¢ï¼ˆæ”¯æŒPWAæ¨¡å¼ï¼‰
      function hideLoading() {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) {
          loadingEl.style.display = 'none';
          console.log('âœ… Flutteråº”ç”¨åŠ è½½å®Œæˆï¼Œéšè—åŠ è½½ç”»é¢');
        }
      }

      // ä»…ä½¿ç”¨flutter-first-frameäº‹ä»¶éšè—åŠ è½½ç”»é¢
      window.addEventListener('flutter-first-frame', hideLoading);

      // å¤‡ç”¨éšè—æœºåˆ¶ï¼ˆé˜²æ­¢åŠ è½½ç”»é¢å¡ä½ï¼‰
      setTimeout(() => {
        if (document.getElementById('loading') && document.getElementById('loading').style.display !== 'none') {
          console.warn('âš ï¸ FlutteråŠ è½½è¶…æ—¶ï¼Œå¼ºåˆ¶éšè—åŠ è½½ç”»é¢');
          hideLoading();
        }
      }, 15000);

    })();
  </script>

  <script src="flutter.js" defer></script>
  <script>
    window.addEventListener('load', function(ev) {
      // ä¿®å¤serviceWorkerVersionæœªå®šä¹‰é—®é¢˜
      const serviceWorkerVersionMeta = document.querySelector('meta[name="flutter-service-worker-version"]');
      const serviceWorkerVersion = serviceWorkerVersionMeta ? serviceWorkerVersionMeta.content : '';
      
      // ä½¿ç”¨ç¨³å®šå¯é çš„æ—§ç‰ˆåˆå§‹åŒ–æ–¹æ³•
      _flutter.loader.loadEntrypoint({
        serviceWorker: {
          serviceWorkerVersion: serviceWorkerVersion,
        },
        onEntrypointLoaded: function(engineInitializer) {
          engineInitializer.initializeEngine().then(function(appRunner) {
            appRunner.runApp();
          });
        }
      });
    });
  </script>

  <script>
    // Stagewise Toolbar Initialization
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      (function() {
        const script = document.createElement('script');
        script.src = 'https://cdn.stagewise.dev/toolbar.js';
        script.async = true;
        script.onload = function() {
          window.Stagewise.init({
            plugins: [],
            environment: 'development'
          });
        };
        document.head.appendChild(script);
      })();
    }
  </script>
</body>
</html>

