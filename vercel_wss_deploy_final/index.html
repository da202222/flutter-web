<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" and is used
    only for generating correct absolute URLs during Flutter initialization,
    when the application is loaded via a web server.

    Placing a leading or trailing slash in the href is not recommended.
    Modify the href attribute when deploying to avoid conflicts with
    web server routing, potentially breaking web app embedding.
  -->
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="皮带秤智能监控系统">
  <meta name="flutter-service-worker-version" content=""43569101"">

  <!-- Mobile web app meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="皮带秤监控系统">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>皮带秤监控系统</title>
  <link rel="manifest" href="manifest.json">


  <!-- MQTT.js 加载（CDN + 本地fallback） -->
  <script>
    function loadMqtt() {
      const cdnUrl = 'https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js';
      const localUrl = 'mqtt.js'; // 实际文件位于web/mqtt.js

      // 创建脚本加载函数
      const loadScript = (url, isFallback = false) => {
        return new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = url;
          script.onload = () => {
            console.log(`MQTT.js ${isFallback ? '本地' : 'CDN'}加载成功`);
            window.mqtt = mqtt; // 设置Dart代码需要的全局变量
            resolve();
          };
          script.onerror = () => {
            console.warn(`加载失败: ${url}`);
            reject();
          };
          document.head.appendChild(script);
        });
      };

      // 先尝试CDN，失败后尝试本地
      loadScript(cdnUrl)
        .catch(() => loadScript(localUrl, true))
        .catch(() => console.error('MQTT.js加载完全失败'));
    }

    window.addEventListener('DOMContentLoaded', loadMqtt);
  </script>

  <!-- WSS连接配置和环境检测 -->
  <script>
    // WSS连接优化和环境检测
    (function() {
      const isHttps = window.location.protocol === 'https:';
      const hostname = window.location.hostname;
      const isVercel = hostname.includes('vercel.app') || hostname.includes('2222503.xyz');
      const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

      // 智能协议选择 - 优先使用WSS
      const mqttConfig = {
        protocol: isHttps ? 'wss' : 'ws',
        host: '117.72.196.137',
        port: isHttps ? 8084 : 8083,
        path: '/mqtt'
      };

      const mqttUrl = `${mqttConfig.protocol}://${mqttConfig.host}:${mqttConfig.port}${mqttConfig.path}`;

      console.log('🌐 WSS环境信息:', {
        protocol: window.location.protocol,
        hostname: hostname,
        isVercel: isVercel,
        isHttps: isHttps,
        isLocalhost: isLocalhost,
        mqttUrl: mqttUrl,
        selectedProtocol: mqttConfig.protocol.toUpperCase()
      });

      // 为Flutter应用提供全局WSS配置
      window.getOptimalMqttConfig = function() {
        return {
          url: mqttUrl,
          config: mqttConfig,
          environment: {
            isHttps: isHttps,
            isVercel: isVercel,
            isLocalhost: isLocalhost,
            hostname: hostname
          },
          wssEnabled: mqttConfig.protocol === 'wss'
        };
      };

      // 智能连接策略 - WSS失败时回退到WS
      window.getSmartMqttConfig = function() {
        const primaryConfig = window.getOptimalMqttConfig();

        // 如果是HTTPS环境但WSS可能有证书问题，提供备用方案
        if (isHttps) {
          const fallbackConfig = {
            protocol: 'ws',
            host: '117.72.196.137',
            port: 8083,
            path: '/mqtt'
          };

          return {
            primary: primaryConfig,
            fallback: {
              url: `${fallbackConfig.protocol}://${fallbackConfig.host}:${fallbackConfig.port}${fallbackConfig.path}`,
              config: fallbackConfig,
              note: 'WSS证书验证失败时的备用连接'
            },
            strategy: 'wss-first-then-ws'
          };
        }

        return {
          primary: primaryConfig,
          fallback: null,
          strategy: 'single-protocol'
        };
      };

      // WSS预连接测试（可选）
      window.testMqttConnection = function() {
        return new Promise((resolve, reject) => {
          try {
            // WSS连接选项 - 模拟MQTTX的配置
            const connectOptions = {
              clientId: 'vercel_wss_test_' + Math.random().toString(16).substr(2, 8),
              clean: true,
              connectTimeout: 15000,  // 增加超时时间
              reconnectPeriod: 0,
              keepalive: 60,
              // 添加WebSocket特定选项
              protocolVersion: 4,
              reschedulePings: true
            };

            // 如果是WSS连接，添加特殊处理
            if (mqttConfig.protocol === 'wss') {
              console.log('🔒 WSS连接配置 (模拟MQTTX SSL/TLS开启，安全验证关闭)');
              // 注意：浏览器环境无法直接关闭证书验证
              // 但可以通过其他方式处理
            }

            const client = mqtt.connect(mqttUrl, connectOptions);

            const timeout = setTimeout(() => {
              client.end();
              reject(new Error('连接超时'));
            }, 15000);

            client.on('connect', () => {
              clearTimeout(timeout);
              console.log('✅ WSS预连接测试成功');
              client.end();
              resolve(true);
            });

            client.on('error', (error) => {
              clearTimeout(timeout);
              console.error('❌ WSS预连接测试失败:', error);

              // 如果是WSS证书错误，提供解决建议
              if (error.message.includes('certificate') || error.message.includes('SSL') || error.message.includes('TLS')) {
                console.warn('💡 WSS证书验证失败，这是正常的，因为浏览器无法像MQTTX一样关闭证书验证');
                console.warn('💡 建议解决方案:');
                console.warn('1. 使用有效的域名证书');
                console.warn('2. 在浏览器中手动信任证书');
                console.warn('3. 使用WS连接作为备用方案');
              }

              reject(error);
            });

          } catch (error) {
            console.error('❌ WSS配置错误:', error);
            reject(error);
          }
        });
      };

      // 调试信息
      window.debugMqttInfo = function() {
        console.log('🔍 MQTT调试信息:', window.getOptimalMqttConfig());
      };

    })();
  </script>

    <style>
      /* 统一字体设置 */
      html, body, flt-semantics, flt-glass-pane, flt-scene-host {
        font-family: -apple-system, BlinkMacSystemFont, 
                     "Segoe UI", "Microsoft YaHei", "微软雅黑", 
                     sans-serif;
        margin: 0;
        padding: 0;
        /* 确保中文字体优先 */
        font-display: swap;
      }
      
      /* 显式声明中文字体 */
      @font-face {
        font-family: "Microsoft YaHei";
        font-style: normal;
        font-weight: 400;
        src: local("Microsoft YaHei"), local("微软雅黑");
      }
    
    /* 加载画面 */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
    }
    
    .loading h1 {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 300;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <h1>皮带秤监控系统</h1>
    <div class="spinner"></div>
    <p style="margin-top: 20px;">正在加载应用...</p>
  </div>

  <script>
    // 隐藏加载画面（支持PWA模式）
    function hideLoading() {
      const loadingEl = document.getElementById('loading');
      if (loadingEl) loadingEl.style.display = 'none';
    }
    
    // 仅使用flutter-first-frame事件隐藏加载画面
    window.addEventListener('flutter-first-frame', hideLoading);
  </script>

  <script src="flutter.js" defer></script>
  <script>
    window.addEventListener('load', function(ev) {
      // 修复serviceWorkerVersion未定义问题
      const serviceWorkerVersionMeta = document.querySelector('meta[name="flutter-service-worker-version"]');
      const serviceWorkerVersion = serviceWorkerVersionMeta ? serviceWorkerVersionMeta.content : '';
      
      // 使用稳定可靠的旧版初始化方法
      _flutter.loader.loadEntrypoint({
        serviceWorker: {
          serviceWorkerVersion: serviceWorkerVersion,
        },
        onEntrypointLoaded: function(engineInitializer) {
          engineInitializer.initializeEngine().then(function(appRunner) {
            appRunner.runApp();
          });
        }
      });
    });
  </script>

  <script>
    // Stagewise Toolbar Initialization
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      (function() {
        const script = document.createElement('script');
        script.src = 'https://cdn.stagewise.dev/toolbar.js';
        script.async = true;
        script.onload = function() {
          window.Stagewise.init({
            plugins: [],
            environment: 'development'
          });
        };
        document.head.appendChild(script);
      })();
    }
  </script>
</body>
</html>
