<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Vercel MQTT WSSè¿æ¥æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .status { 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            font-weight: bold;
            backdrop-filter: blur(5px);
        }
        .success { background: rgba(40, 167, 69, 0.8); }
        .error { background: rgba(220, 53, 69, 0.8); }
        .info { background: rgba(23, 162, 184, 0.8); }
        .warning { background: rgba(255, 193, 7, 0.8); color: #212529; }
        
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .btn-primary { background: rgba(0, 123, 255, 0.8); color: white; }
        .btn-primary:hover { background: rgba(0, 123, 255, 1); transform: translateY(-2px); }
        .btn-success { background: rgba(40, 167, 69, 0.8); color: white; }
        .btn-success:hover { background: rgba(40, 167, 69, 1); transform: translateY(-2px); }
        
        #log { 
            height: 400px; 
            overflow-y: auto; 
            border: 1px solid rgba(255,255,255,0.3); 
            padding: 15px; 
            background: rgba(0,0,0,0.3); 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            line-height: 1.4;
            border-radius: 8px;
        }
        
        .vercel-info {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .connection-card {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Vercel MQTT WSSè¿æ¥æµ‹è¯•</h1>
        
        <div class="vercel-info">
            <h3>ğŸŒ Verceléƒ¨ç½²ç¯å¢ƒä¿¡æ¯</h3>
            <div id="envInfo"></div>
        </div>

        <div class="status info">
            <strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus">æœªè¿æ¥</span><br>
            <strong>æ¨èåè®®:</strong> <span id="recommendedProtocol">WSS (HTTPSç¯å¢ƒ)</span>
        </div>

        <div class="connection-grid">
            <div class="connection-card">
                <h4>ğŸ”’ WSSè¿æ¥</h4>
                <p>HTTPSç¯å¢ƒæ¨è</p>
                <button class="btn-success" onclick="testWSS()">æµ‹è¯•WSS:8084</button>
            </div>
            <div class="connection-card">
                <h4>ğŸŒ WSè¿æ¥</h4>
                <p>HTTPç¯å¢ƒå¤‡ç”¨</p>
                <button class="btn-primary" onclick="testWS()">æµ‹è¯•WS:8083</button>
            </div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn-success" onclick="sendTestMessage()">ğŸ“¤ å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button class="btn-primary" onclick="disconnect()">ğŸ”Œ æ–­å¼€è¿æ¥</button>
            <button class="btn-warning" onclick="trustCertificate()">ğŸ”’ ä¿¡ä»»SSLè¯ä¹¦</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="status" id="statusDisplay" style="display:none;">
            <span id="statusText">å‡†å¤‡æµ‹è¯•...</span>
        </div>

        <div>
            <h3>ğŸ“‹ è¿æ¥æ—¥å¿—</h3>
            <div id="log"></div>
        </div>

        <div class="vercel-info">
            <h3>ğŸ“ ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li>âœ… <strong>WSSè¿æ¥</strong>: é€‚ç”¨äºHTTPSç¯å¢ƒ (Verceléƒ¨ç½²)</li>
                <li>ğŸ”„ <strong>WSè¿æ¥</strong>: é€‚ç”¨äºHTTPç¯å¢ƒ (æœ¬åœ°å¼€å‘)</li>
                <li>ğŸ” <strong>åŒ¿åè®¿é—®</strong>: æ— éœ€ç”¨æˆ·åå¯†ç </li>
                <li>ğŸ“¡ <strong>æœåŠ¡å™¨</strong>: 117.72.196.137</li>
            </ul>

            <h4>ğŸ”’ WSSè¯ä¹¦è¯´æ˜</h4>
            <div style="background: rgba(255,193,7,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
                <p><strong>âš ï¸ é‡è¦æç¤º:</strong></p>
                <ul>
                    <li>MQTTXå¯ä»¥å…³é—­SSLè¯ä¹¦éªŒè¯ (SSLå®‰å…¨: å…³é—­)</li>
                    <li>æµè§ˆå™¨æ— æ³•å…³é—­è¯ä¹¦éªŒè¯ï¼Œéœ€è¦æœ‰æ•ˆè¯ä¹¦</li>
                    <li>å¦‚æœWSSè¿æ¥å¤±è´¥ï¼Œä¼šè‡ªåŠ¨å°è¯•WSè¿æ¥</li>
                </ul>
            </div>

            <h4>ğŸ› ï¸ å¦‚æœWSSè¿æ¥å¤±è´¥</h4>
            <div style="background: rgba(23,162,184,0.2); padding: 10px; border-radius: 5px; margin: 10px 0;">
                <p><strong>è§£å†³æ–¹æ¡ˆ:</strong></p>
                <ol>
                    <li>åœ¨æµè§ˆå™¨ä¸­è®¿é—®: <code>https://117.72.196.137:8084</code></li>
                    <li>ç‚¹å‡»"é«˜çº§" â†’ "ç»§ç»­è®¿é—®"æ¥ä¿¡ä»»è¯ä¹¦</li>
                    <li>æˆ–è€…ä½¿ç”¨WSè¿æ¥ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        let client = null;
        
        function initPage() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isVercel = hostname.includes('vercel.app') || hostname.includes('2222503.xyz');
            const isHttps = protocol === 'https:';
            
            document.getElementById('envInfo').innerHTML = `
                <strong>åŸŸå:</strong> ${hostname}<br>
                <strong>åè®®:</strong> ${protocol}<br>
                <strong>Vercelç¯å¢ƒ:</strong> ${isVercel ? 'æ˜¯' : 'å¦'}<br>
                <strong>HTTPS:</strong> ${isHttps ? 'æ˜¯' : 'å¦'}
            `;
            
            log('ğŸš€ Vercel MQTTæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log(`ğŸŒ å½“å‰ç¯å¢ƒ: ${hostname} (${protocol})`);
            log(`ğŸ“ Verceléƒ¨ç½²: ${isVercel ? 'æ˜¯' : 'å¦'}`);
            
            if (isHttps) {
                log('ğŸ”’ HTTPSç¯å¢ƒæ£€æµ‹åˆ°ï¼Œæ¨èä½¿ç”¨WSSè¿æ¥');
                document.getElementById('recommendedProtocol').textContent = 'WSS (HTTPSç¯å¢ƒ)';
            } else {
                log('âš ï¸ HTTPç¯å¢ƒï¼Œå»ºè®®ä½¿ç”¨WSè¿æ¥');
                document.getElementById('recommendedProtocol').textContent = 'WS (HTTPç¯å¢ƒ)';
            }
        }
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusDisplay');
            const statusText = document.getElementById('statusText');
            statusDiv.style.display = 'block';
            statusDiv.className = `status ${type}`;
            statusText.textContent = message;
            
            document.getElementById('connectionStatus').textContent = message;
        }
        
        function testWSS() {
            connectToMQTT('wss://117.72.196.137:8084/mqtt', 'WSSè¿æ¥ (æ¨è)');
        }
        
        function testWS() {
            connectToMQTT('ws://117.72.196.137:8083/mqtt', 'WSè¿æ¥ (å¤‡ç”¨)');
        }
        
        function connectToMQTT(url, testName) {
            if (client) {
                client.end();
                client = null;
            }
            
            log(`ğŸ”„ å¼€å§‹${testName}: ${url}`);
            updateStatus(`æ­£åœ¨è¿æ¥${testName}...`, 'info');
            
            const options = {
                clientId: 'vercel_test_' + Math.random().toString(16).substr(2, 8),
                clean: true,
                connectTimeout: 15000,
                reconnectPeriod: 0,
                keepalive: 60,
            };
            
            try {
                client = mqtt.connect(url, options);
                
                const timeout = setTimeout(() => {
                    log(`âŒ ${testName}è¿æ¥è¶…æ—¶`);
                    updateStatus(`${testName}è¿æ¥è¶…æ—¶`, 'error');
                    if (client) {
                        client.end();
                        client = null;
                    }
                }, 15000);
                
                client.on('connect', () => {
                    clearTimeout(timeout);
                    log(`âœ… ${testName}è¿æ¥æˆåŠŸ! (Vercelç¯å¢ƒ)`);
                    updateStatus(`${testName}è¿æ¥æˆåŠŸ`, 'success');
                    
                    // è®¢é˜…æµ‹è¯•ä¸»é¢˜
                    client.subscribe('vercel/test', (err) => {
                        if (err) {
                            log(`âŒ è®¢é˜…å¤±è´¥: ${err.message}`);
                        } else {
                            log(`âœ… è®¢é˜…ä¸»é¢˜æˆåŠŸ: vercel/test`);
                        }
                    });
                });
                
                client.on('error', (error) => {
                    clearTimeout(timeout);
                    log(`âŒ ${testName}è¿æ¥å¤±è´¥: ${error.message}`);
                    updateStatus(`${testName}è¿æ¥å¤±è´¥`, 'error');
                    
                    if (error.message.includes('WebSocket')) {
                        log('ğŸ’¡ WSSè¿æ¥é—®é¢˜å¯èƒ½åŸå› :');
                        log('1. MQTTæœåŠ¡å™¨WSSç«¯å£æœªé…ç½®');
                        log('2. SSLè¯ä¹¦é—®é¢˜');
                        log('3. é˜²ç«å¢™é˜»æ­¢è¿æ¥');
                    }
                    
                    client = null;
                });
                
                client.on('message', (topic, message) => {
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [${topic}]: ${message.toString()}`);
                });
                
            } catch (error) {
                log(`âŒ ${testName}è¿æ¥å¼‚å¸¸: ${error.message}`);
                updateStatus(`${testName}è¿æ¥å¼‚å¸¸`, 'error');
            }
        }
        
        function sendTestMessage() {
            if (!client) {
                log('âŒ è¯·å…ˆå»ºç«‹è¿æ¥');
                updateStatus('è¯·å…ˆè¿æ¥', 'warning');
                return;
            }
            
            const testData = {
                timestamp: new Date().toISOString(),
                message: 'Hello from Vercel deployment!',
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                userAgent: navigator.userAgent.substring(0, 50) + '...'
            };
            
            client.publish('vercel/test', JSON.stringify(testData, null, 2), (err) => {
                if (err) {
                    log(`âŒ å‘å¸ƒå¤±è´¥: ${err.message}`);
                } else {
                    log(`âœ… Vercelæ¶ˆæ¯å‘å¸ƒæˆåŠŸ`);
                    log(`ğŸ“¤ æ¶ˆæ¯å†…å®¹: ${JSON.stringify(testData)}`);
                }
            });
        }
        
        function disconnect() {
            if (client) {
                client.end();
                client = null;
                log(`ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥`);
                updateStatus('å·²æ–­å¼€è¿æ¥', 'info');
            }
        }
        
        function trustCertificate() {
            log('ğŸ”’ å°è¯•ä¿¡ä»»SSLè¯ä¹¦...');

            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€HTTPSåœ°å€ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ä¿¡ä»»è¯ä¹¦
            const certUrl = 'https://117.72.196.137:8084';
            const certWindow = window.open(certUrl, '_blank', 'width=800,height=600');

            log('ğŸ“‹ è¯·åœ¨æ–°çª—å£ä¸­:');
            log('1. ç‚¹å‡»"é«˜çº§"æˆ–"Advanced"');
            log('2. ç‚¹å‡»"ç»§ç»­è®¿é—®"æˆ–"Proceed to 117.72.196.137"');
            log('3. å…³é—­çª—å£åé‡æ–°æµ‹è¯•WSSè¿æ¥');

            // æ£€æµ‹çª—å£å…³é—­
            const checkClosed = setInterval(() => {
                if (certWindow.closed) {
                    clearInterval(checkClosed);
                    log('âœ… è¯ä¹¦ä¿¡ä»»çª—å£å·²å…³é—­ï¼Œè¯·é‡æ–°æµ‹è¯•WSSè¿æ¥');
                    updateStatus('è¯·é‡æ–°æµ‹è¯•WSSè¿æ¥', 'info');
                }
            }, 1000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>
